# Интеграция новой системы прохождения кейсов (3 фазы)

## Обзор

Реализована новая архитектура прохождения кейсов с тремя фазами:
1. **Фаза 1: Опрос** - Чат с AI-пациентом для сбора анамнеза
2. **Фаза 2: Диагностика** - Выбор методов обследования (объективный, лабораторный, инструментальный)
3. **Фаза 3: Лечение** - Заполнение назначений и плана лечения

## Структура файлов

### Клиентская часть (React)

```
src/components/CaseFlow/
├── CaseFlow.js          # Главный компонент, управляет фазами
├── Phase1Interview.js   # Фаза 1: Опрос (чат)
├── Phase2Diagnostics.js # Фаза 2: Диагностика
├── Phase3Treatment.js   # Фаза 3: Лечение
├── CaseResults.js       # Результаты и обратная связь
└── CaseFlow.css         # Стили для всех компонентов
```

### Серверная часть (Node.js)

```
server/src/
├── data/
│   └── diagnosticDatabase.js  # База данных диагностических методов
├── services/
│   └── evaluationService.js   # Сервис оценки действий студента
└── routes/
    └── diagnostics.js         # API для работы с диагностикой
```

## Использование

### 1. Импорт компонента

```javascript
import CaseFlow from './components/CaseFlow/CaseFlow';
```

### 2. Использование в App.js

```javascript
// В компоненте, где отображается кейс
const [showCaseFlow, setShowCaseFlow] = useState(false);
const [selectedCaseId, setSelectedCaseId] = useState(null);

// При выборе кейса
const handleStartCase = (caseId) => {
  setSelectedCaseId(caseId);
  setShowCaseFlow(true);
};

// Рендер
{showCaseFlow && selectedCaseId && (
  <CaseFlow
    caseId={selectedCaseId}
    onComplete={() => {
      // Кейс завершен, можно перейти к следующему
      setShowCaseFlow(false);
      // Обновить статистику и т.д.
    }}
    onExit={() => {
      setShowCaseFlow(false);
      setSelectedCaseId(null);
    }}
  />
)}
```

## API Endpoints

### GET /api/diagnostics/methods
Получить все доступные методы диагностики

**Ответ:**
```json
{
  "objective": {
    "general": { "id": "general_condition", "name": "Общее состояние", ... },
    "temperature": { ... },
    ...
  },
  "laboratory": { ... },
  "instrumental": { ... }
}
```

### POST /api/diagnostics/results
Получить результат диагностики для конкретного кейса

**Запрос:**
```json
{
  "methodId": "cbc",
  "caseId": "salmonellosis_moderate"
}
```

**Ответ:**
```json
{
  "result": {
    "wbc": 12.5,
    "wbc_interpretation": "Лейкоцитоз",
    ...
  }
}
```

### POST /api/cases/:id/complete
Завершить прохождение кейса и получить оценку

**Запрос:**
```json
{
  "interviewProgress": {
    "questionsCount": 12,
    "collected": {
      "complaints": true,
      "anamnesis": true,
      ...
    }
  },
  "selectedMethods": ["general_condition", "temperature", "cbc", ...],
  "treatmentData": {
    "diagnosis": { "main": "Сальмонеллез", ... },
    "medications": [...],
    ...
  }
}
```

**Ответ:**
```json
{
  "score": 78,
  "maxScore": 100,
  "feedback": "Хорошая работа!",
  "correctActions": [...],
  "improvements": [...],
  "criticalErrors": [],
  "protocol": {...},
  "economics": {...}
}
```

## База данных диагностики

База данных диагностики (`diagnosticDatabase.js`) содержит:

- **Объективный осмотр** (~10 методов): общее состояние, температура, витальные показатели, живот, тургор кожи и т.д.
- **Лабораторная диагностика** (~15 методов): ОАК, ОАМ, биохимия, электролиты, копрограмма, бакпосев и т.д.
- **Инструментальная диагностика** (~10 методов): рентген, УЗИ, КТ, ЭКГ, ФГДС, колоноскопия и т.д.

Каждый метод содержит:
- `id` - уникальный идентификатор
- `name` - название метода
- `category` - категория (objective/laboratory/instrumental)
- `time_needed` - время получения результата (в минутах, 0 = мгновенно)
- `cost` - стоимость (в тенге)
- `results` - результаты для разных кейсов

## Система оценки

Сервис оценки (`evaluationService.js`) оценивает:

1. **Опрос (20 баллов)**
   - Сбор жалоб (5 баллов)
   - Анамнез заболевания (5 баллов)
   - Эпиданамнез (5 баллов)
   - Аллергии (3 балла)
   - Хронические заболевания (2 балла)

2. **Диагностика (30 баллов)**
   - Объективный осмотр (3 балла за каждый обязательный метод)
   - Лабораторные методы (5 баллов за каждый обязательный)
   - Штраф за лишние методы

3. **Лечение (40 баллов)**
   - Правильные препараты (10 баллов за каждый)
   - Регидратация (10 баллов, обязательно при ОКИ)
   - Диета (5 баллов)
   - Режим (5 баллов)
   - Критические ошибки (штраф до 20 баллов)

4. **Диагноз (10 баллов)**
   - Правильный диагноз (10 баллов)
   - Неправильный диагноз (штраф 15 баллов)

## Интеграция с протоколами МЗ РК

В `evaluationService.js` есть функция `getDefaultProtocol()`, которая возвращает протокол лечения. В будущем это можно расширить для загрузки протоколов с MedElement.

## Экономика

Система рассчитывает стоимость:
- Обследования (сумма всех выбранных методов)
- Лечения (стоимость препаратов на курс)
- Общая стоимость приема

Также отмечает лишние назначения, которые увеличивают стоимость без необходимости.

## Следующие шаги

1. **Интеграция в App.js** - заменить старый ChatSimulation на новый CaseFlow
2. **База данных протоколов** - создать БД протоколов МЗ РК
3. **Статистика пользователя** - сохранять результаты прохождения в БД
4. **Расширение базы диагностики** - добавить больше методов и результатов для разных кейсов
5. **Улучшение AI-оценки** - более точная оценка с использованием LLM для анализа ответов

## Примеры использования

### Добавление нового метода диагностики

```javascript
// В diagnosticDatabase.js
laboratory: {
  new_test: {
    id: 'new_test',
    name: 'Новый тест',
    category: 'laboratory',
    time_needed: 60,
    cost: 2000,
    results: {
      salmonellosis_moderate: {
        value: 'положительный',
        interpretation: 'Подтверждает диагноз'
      }
    }
  }
}
```

### Добавление нового кейса в базу диагностики

Для каждого нового кейса нужно добавить результаты в существующие методы:

```javascript
results: {
  salmonellosis_moderate: { ... },
  new_case_id: {
    // Результаты для нового кейса
  }
}
```

## Примечания

- Все результаты диагностики предопределены в БД (не генерируются AI) для экономии токенов
- Поведение пациента (4 варианта) генерируется случайно при каждом прохождении
- Медицинское ядро (симптомы) кэшируется на 30 минут
- Персонаж (имя, возраст, история) генерируется каждый раз заново



